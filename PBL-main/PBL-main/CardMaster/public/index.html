<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="./static/assets/css/main.css" />

  <link href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet"
    media="all">


  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"
    media="all">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.5.2/animate.min.css" rel="stylesheet" media="all">


  <!-- Bootstrap bootstrap-touch-slider Slider Main Style Sheet -->
  <link href="./static/assets/css/bootstrap-touch-slider.css" rel="stylesheet" media="all">

  <title>Document</title>
</head>

<body class="homepage is-preload">
  <div id="page-wrapper">
    <!-- Nav -->
    <nav id="nav">
      <ul>
        <li class="current"><a href="index">Home</a></li>
        <li><a href="buy">구매</a></li>
        <li><a href="sales">판매</a></li>
        <li><a href="login" id="isLogin">로그인</a></li>
      </ul>
    </nav>
    <!-- 추가부분 -->

    <section id="bootstrap-touch-slider" class="carousel bs-slider fade  control-round indicators-line"
      data-ride="carousel" data-pause="hover" data-interval="false">

      <!-- Indicators -->
      <ol class="carousel-indicators">
        <li data-target="#bootstrap-touch-slider" data-slide-to="0" class="active"></li>
        <li data-target="#bootstrap-touch-slider" data-slide-to="1"></li>
        <li data-target="#bootstrap-touch-slider" data-slide-to="2"></li>
        <li data-target="#bootstrap-touch-slider" data-slide-to="3"></li>
        <li data-target="#bootstrap-touch-slider" data-slide-to="4"></li>
        <li data-target="#bootstrap-touch-slider" data-slide-to="5"></li>
      </ol>

      <!-- Wrapper For Slides -->
      <div class="carousel-inner" role="listbox">

        <!-- Third Slide -->
        <div class="item active">

          <!-- Slide Background -->
          <img src="./static/images/gTicketPoster1.gif" alt="Bootstrap Touch Slider" class="slide-image" />
          <div class="bs-slider-overlay"></div>

          <div class="container">
            <div class="row">
              <!-- Slide Text Layer -->
              <div class="slide-text slide_style_left">
                <h1 data-animation="animated zoomInRight">Shirley Lane Rock'n Roll Festival</h1>
                <p data-animation="animated fadeInLeft">최고 수준의 재즈락을 생생하게 즐길 수 있는 기회! </p>
                <a class="btn btn-default" data-animation="animated fadeInLeft" id="ticket1"
                  onclick="ticket('Shirley Lane Rock\'n Roll Festival')">티켓 예매</a>
                <a href="sales" target="_blank" class="btn btn-primary" data-animation="animated fadeInRight">티켓 정보</a>
              </div>
            </div>
          </div>
        </div>
        <!-- End of Slide -->

        <!-- Second Slide -->
        <div class="item">

          <!-- Slide Background -->
          <img src="./static/images/gTicketPoster2.gif" alt="Silent Street" class="slide-image" />
          <div class="bs-slider-overlay"></div>
          <!-- Slide Text Layer -->
          <div class="slide-text slide_style_center">
            <h1 data-animation="animated flipInX">Silent Street</h1>
            <p data-animation="animated lightSpeedIn">깊은 밤 고요한 적막 속에 숨어있는 미스테리를 찾아라</p>
            <a class="btn btn-default" data-animation="animated fadeInLeft" id="ticket2"
              onclick="ticket('Silent Street')">티켓 예매</a>
            <a href="sales" target="_blank" class="btn btn-primary" data-animation="animated fadeInDown">티켓 정보</a>
          </div>
        </div>
        <!-- End of Slide -->

        <!-- Third Slide -->
        <div class="item">

          <!-- Slide Background -->
          <img src="./static/images/gTicketPoster3.gif" alt="Last Stand" class="slide-image" />
          <div class="bs-slider-overlay"></div>
          <!-- Slide Text Layer -->
          <div class="slide-text slide_style_right">
            <h1 data-animation="animated zoomInLeft">Last Stand</h1>
            <p data-animation="animated fadeInRight">거장 Claudia Alves 감독의 2번째 시리즈. 한 남자의 마지막 저항이 시작된다!</p>
            <a class="btn btn-default" data-animation="animated fadeInLeft" id="ticket3"
              onclick="ticket('Last Stand')">티켓 예매</a>
            <a href="sales" target="_blank" class="btn btn-primary" data-animation="animated fadeInRight">티켓 정보</a>
          </div>
        </div>
        <!-- End of Slide -->

        <!-- 4 Slide -->
        <div class="item">

          <!-- Slide Background -->
          <img src="./static/images/gTicketPoster4.gif" alt="The Train of Love" class="slide-image" />
          <div class="bs-slider-overlay"></div>
          <!-- Slide Text Layer -->
          <div class="slide-text slide_style_center">
            <h1 data-animation="animated flipInX">The Train of Love</h1>
            <p data-animation="animated lightSpeedIn">베스트셀러 소설을 원작으로 한 감동적인 스토리. 처음 만났던 기차에서 두 사람은 다시 마주칠 수 있을까?</p>
            <a class="btn btn-default" data-animation="animated fadeInLeft" id="ticket4"
              onclick="ticket('The Train of Love')">티켓 예매</a>
            <a href="sales" target="_blank" class="btn btn-primary" data-animation="animated fadeInDown">티켓 정보</a>
          </div>
        </div>
        <!-- End of Slide -->

        <!-- 5 Slide -->
        <div class="item">

          <!-- Slide Background -->
          <img src="./static/images/gTicketPoster5.gif" alt="en route" class="slide-image" />
          <div class="bs-slider-overlay"></div>

          <div class="container">
            <div class="row">
              <!-- Slide Text Layer -->
              <div class="slide-text slide_style_left">
                <h1 data-animation="animated zoomInRight">en route</h1>
                <p data-animation="animated fadeInLeft">성공만을 바라봤던 두 젊은 남녀의 해피엔딩 성장 스토리</p>
                <a class="btn btn-default" data-animation="animated fadeInLeft" id="ticket5"
                  onclick="ticket('en route')">티켓 예매</a>
                <a href="sales" target="_blank" class="btn btn-primary" data-animation="animated fadeInRight">티켓 정보</a>
              </div>
            </div>
          </div>
        </div>
        <!-- End of Slide -->

        <!-- 6 Slide -->
        <div class="item">

          <!-- Slide Background -->
          <img src="./static/images/gTicketPoster6.gif" alt="Live The Music" class="slide-image" />
          <div class="bs-slider-overlay"></div>
          <!-- Slide Text Layer -->
          <div class="slide-text slide_style_right">
            <h1 data-animation="animated zoomInLeft">Live The Music</h1>
            <p data-animation="animated fadeInRight">짜릿한 함성! 뜨거운 열기!
              세계 10대 락페스티벌로 손꼽히는 라이브더뮤직페스티벌의 화려한 부활!</p>
            <a class="btn btn-default" data-animation="animated fadeInLeft" id="ticket6"
              onclick="ticket('Live The Music')">티켓 예매</a>
            <a href="sales" target="_blank" class="btn btn-primary" data-animation="animated fadeInRight">티켓 정보o</a>
          </div>
        </div>
        <!-- End of Slide -->



      </div><!-- End of Wrapper For Slides -->

      <!-- Left Control -->
      <a class="left carousel-control" href="#bootstrap-touch-slider" role="button" data-slide="prev">
        <span class="fa fa-angle-left" aria-hidden="true"></span>
        <span class="sr-only">Previous</span>
      </a>

      <!-- Right Control -->
      <a class="right carousel-control" href="#bootstrap-touch-slider" role="button" data-slide="next">
        <span class="fa fa-angle-right" aria-hidden="true"></span>
        <span class="sr-only">Next</span>
      </a>

    </section> <!-- End  bootstrap-touch-slider Slider -->



    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.touchswipe/1.6.18/jquery.touchSwipe.min.js"></script>


    <!-- Bootstrap bootstrap-touch-slider Slider Main JS File -->
    <script src="./static/assets/js/bootstrap-touch-slider.js"></script>

    <script type="text/javascript">
      $('#bootstrap-touch-slider').bsTouchSlider();
    </script>
  </div>
</body>

<body>
  <form method="post">
    <table>
      <tr>
        <!--<td><label>아이디</label></td>
            <td><input type="text" name="id" id="id"></td>-->
      </tr>

    </table>
  </form>

  <script src="https://code.jquery.com/jquery-3.4.1.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-firestore.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.6.5/firebase-storage.js"></script>

  <script>
    var firebaseConfig = {
      apiKey: "AIzaSyDYu8NfIoLK2iQj-3PTmcYRGmqS5B3f4Uo",
      authDomain: "dbpbl-13bbf.firebaseapp.com",
      databaseURL: "https://dbpbl-13bbf-default-rtdb.firebaseio.com",
      projectId: "dbpbl-13bbf",
      storageBucket: "dbpbl-13bbf.appspot.com",
      messagingSenderId: "379273770681",
      appId: "1:379273770681:web:b25788b8098ffb4a7c8d68",
      measurementId: "G-EN3FK5T60E"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
  </script>
  <script>
    var userid;
    const db = firebase.firestore();
    //사용자 아이디 
    firebase.auth().onAuthStateChanged((user) => {
      if (user) {
        userid = user.uid; //사용자 아이디 가져옴
        console.log(userid);
      } else {

      }
    });

    var ticketGet = 0; //티켓 매진

    // 예매 함수
    function ticket(ticketName) {
      //로그인 되어 있는 경우
      if (userid) {
        //ticket 컬렉션에서 tNumber을 오름차순 정렬, 1개만 가져옴
        db.collection('ticket')
          .orderBy("tNumber", "asc").limit(1)
          .where("uid", "==", "null")
          .where("tName", "==", ticketName)
          .get().then((res) => {

            res.forEach((doc) => {
              ticketGet = 1;  //티켓 예매 가능 상태(예매 성공함)
              console.log(doc.id)
              console.log("티켓 예매 완료")
              alert("예매 성공");

              //티켓 정보 가져와서 소유자명 변경하기
              db.collection('ticket').doc(doc.id).update({
                "uid": userid,
                "price": "null"
              }).then(() => {
                console.log("Document successfully updated!");
              })
                .catch((error) => {
                  // The document probably doesn't exist.
                  console.error("Error updating document: ", error);
                });

            })
            if (ticketGet == 0) {  //예매 못함 ->매진
              console.log("매진")
              alert("매진");
            }

          });
        ticketGet = 0;  //다시 예매를 시도할 수 있으니까 예매 못할 수도 있다는 가정
      } else {  //로그인 안되어 있는 경우
        alert("로그인 후 이용 가능합니다.");
      }
    }


    var userid
    firebase.auth().onAuthStateChanged((user) => {
      if (user) {
        $('#isLogin').text('로그아웃');
        //로그아웃 클릭 시
        $('#isLogin').click(function () {
          firebase.auth().signOut().then(function () {
            alert("로그아웃 되었습니다")
            //로그인 페이지로 이동시키고 세션 저장시키기
            window.location.href = "login"
          }).catch(function (error) {
            if (error) {
              alert("로그인 실패");
            }
          });
        });
      }
    });

  </script>

</body>

</html>